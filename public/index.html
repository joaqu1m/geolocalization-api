<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>localGet</title>
</head>
<body>
    <h2>input</h2>
    <p id="textoCordenadas"></p>
    <h2>output</h2>
    <p id="recebido" style="background-color: black; color: white;"></p>
</body>
</html>
<script>
    function enviarDados(position) {
        // TODO: Coletar "Precisão da coleta" de dentro do position
        console.log(position)
        lat = position.coords.latitude
        lng = position.coords.longitude
        console.log("Nova inserção")
        
        const date = new Date()
        var dia = ""
        var hora = ""
        dateTime = [String(date.getDate()), String(date.getMonth()+1), String(date.getFullYear()), String(date.getHours()), String(date.getMinutes()), String(date.getSeconds())]
        for (i = 0; i < 6; i++) {
            if (i == 1 || i == 2) {dia += `/`} else if (i == 4 || i == 5) {hora += `:`}
            if (dateTime[i].length < 2) {
                if (i < 3) {dia += `0${dateTime[i]}`} else {hora += `0${dateTime[i]}`}
            } else {
                if (i < 3) {dia += dateTime[i]} else {hora += dateTime[i]}
            }
        }

        textoCordenadas.innerHTML = `Latitude: ${lat}<br>Longitude: ${lng}<br>Data: ${dia}<br>Horário:${hora}`

        fetch("/query/inserir", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                latitude: lat,
                longitude: lng,
                dia: dia,
                hora: hora,
                fkTotem: 50000
            })
        }).then((response) => {
            console.log(response)
            if (response.ok) {
                recebido.innerHTML = `Inserção concluída com sucesso! <br>lat:${lat}<br>lng${lng}<br>data:${dia}<br>horario:${hora}<br>totem:50000`
            } else {
                recebido.innerHTML = "Erro: Acesso ao banco negado"
            }
        })
        .catch((response) => {
            console.log(response)
            recebido.innerHTML = "Erro: Aplicação Node.js"
        })
    }
    function erro(err) {
        recebido.innerHTML = `Erro: Acesso a geolocalização negado. Código de erro ${err.code}`
    }
    function repeticao() {
        navigator.geolocation.getCurrentPosition(enviarDados, erro, {
            enableHighAccuracy: true
        })
    }
    setInterval(repeticao, 5000)
</script>